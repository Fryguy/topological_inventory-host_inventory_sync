#!/usr/bin/env ruby

lib = File.expand_path("../../lib", __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

STDOUT.sync = true

require "bundler/setup"
require "topological_inventory/host_inventory_sync"

def parse_args
  require 'optimist'
  opts = Optimist.options do
    opt :queue_host, "Hostname of the Platform's kafka queue", :type => :string, :required => ENV["QUEUE_HOST"].nil?, :default => ENV["QUEUE_HOST"]
    opt :queue_port, "Port of the Platform's kafka queue", :type => :int, :required => false, :default => (ENV["QUEUE_PORT"] || 9092).to_i
    opt :topological_inventory_api, "Topological Inventory service URL", :type => :string, :required => ENV["TOPOLOGICAL_INVENTORY_API_SERVICE_HOST"].nil?
    opt :host_inventory_api, "Host inventory service URL", :type => :string, :required => ENV["HOST_INVENTORY_API"].nil?
    opt :ingress_api, "Ingress API service URL", :type => :string, :required => ENV["TOPOLOGICAL_INVENTORY_INGRESS_API_SERVICE_HOST"].nil?
  end

  opts
end

args = parse_args

ingress_api_uri = if args[:ingress_api]
                    URI(args[:ingress_api])
                  else
                    require 'uri'
                    URI::HTTP.build(:host => ENV["TOPOLOGICAL_INVENTORY_INGRESS_API_SERVICE_HOST"], :port => ENV["TOPOLOGICAL_INVENTORY_INGRESS_API_SERVICE_PORT"])
                  end

TopologicalInventoryIngressApiClient.configure.scheme = ingress_api_uri.scheme || "http"
TopologicalInventoryIngressApiClient.configure.host   = "#{ingress_api_uri.host}:#{ingress_api_uri.port}"

host_inventory_sync = TopologicalInventory::HostInventorySync.new(
  args[:topological_inventory_api], args[:host_inventory_api], args[:queue_host], args[:queue_port]
)

host_inventory_sync.run
